<!DOCTYLE html>
<html lang='en'>

<head>
    <title>VISUALIZATION</title>
    <style>
    body {
        font-family: sans-serif;
    }
    
    #mapLegend {
        padding-right: 40px;
        float: right;
    }
    
    circle {
        opacity: 0.85;
    }
    
    .domain {
        fill: none;
        stroke: #000;
    }
    
    .tick {
        font-size: 15;
    }
    
    .tick line {
        stroke: #ccc;
    }
    
    #tooltip {
        position: absolute;
        right: 5;
        background-color: rgba(192, 188, 188, 0.4);
        padding: 5;
        border: solid 1px grey;
        visibility: hidden;
        transition: all 0.2s;
    }
    </style>
</head>

<body>
    <div id='mapLegend'>
        <h5>Relative Pollution<p>Values</h3>
            <svg width="100" height="800">
                <g id='legend'></g>
            </svg>
            <div id="tooltip">ToolTip</div>
        </div>
    </body>
    
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <script>
        //Parameters
        var height = 550;
        var width = 1000;
        var margin = {top: 20, left: 30, right: 20, bottom: 20};
        var innerHeight = height - margin.top - margin.bottom;
        var innerWidth = width - margin.left - margin.right;
        var colorRange = ['#00a3e0', '#000000', '#a45a2a', '#da291c', '#10069f', '#e89cae', '#7c878e', '#007a33', '#ffcd00', '#840b55', '#00b2a9'];
       
        //global variables
        var data = [];
        var chart = d3.select("#legend");
        var yAxisGroup = chart.append('g')
            .attr('transform', "translate(" 
                  + margin.left
                  + "," 
                  + margin.top + ")");
        var dotGroup = chart.append('g')
            .attr('transform', "translate(" + margin.left + "," + margin.top + ")");

        //Global functions
        function highlight(name) {
            dotGroup.selectAll('circle').style("stroke", function(d,i) {
                return d.N});
        }
        
        function unHighlight() {
            dotGroup.selectAll('circle').style("stroke", undefined);
        }
        
        //Render the chart
        function renderChart(values) {
            //chart properties
            chart
                .attr('height', height)
            
            //set scales
            var yScale = d3.scale.sqrt()
                .range([innerHeight, 0])
                .domain(d3.extent(values, function(d) {return d.N}));
            var colorScale = d3.scale.ordinal().range(colorRange);
            
            //set axes
            var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient('left')
            
            //call the axis groups    
            yAxisGroup.call(yAxis);
            
            //add the circles to the plot
            dotGroup.selectAll("circle")
                .data(values, function(d) {return d.N})
                .enter()
                .append("circle")
                    .attr('r',3)
                    .attr("cy", function(d,i) {return yScale(d.N)})
                    .attr("fill", function(d,i) {return colorScale(d.line)})
                    .on('click', function(d,i) {alert(d.N)})
                    .on('mouseenter', function(d,i) {
                        highlight(d.N);
                        d3.select('#tooltip').style({
                            visibility: 'visible',
                            top: d3.event.clientY,
                            left: d3.event.clientX
                        }).html("Line: " + d.line + "<p>" + "Station: " + d.station + "<p>" + "Pollution: " + d.N)
                    })
                    .on('mouseleave', function(d,i) {
                        unHighlight(d.N);
                        d3.select('#tooltip').style({
                            visibility: 'hidden'
                        })
                    })
            
            dotGroup.selectAll("circle").transition()
                .attr('r',5)
                .attr("cy", function(d,i) {return yScale(d.N)})
                .attr("fill", function(d,i) {return colorScale(d.line)})
        }
        
        //master render function
        function render(data) {
            /*//parse values for relevant values
            var parsed = data.filter(function(d) {return d.N 
                != undefined});
            var filtered = parsed.filter(function (d) {return d.N != undefined});
            
            //render visuals*/
            renderChart(data);
        }
        
        //Load data, run visualizations        
        d3.csv('{{ url_for('static', filename='resources/CUSPTubeDummy.csv') }}', 
        function(error, result) {
            data = result;
            render(result);
        })   
    </script>
</html>
